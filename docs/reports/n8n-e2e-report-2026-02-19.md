# N8N E2E Test Report — 2026-02-19

## Executive Summary

| Metric | Value |
|--------|-------|
| **N8N Version** | v2.8.3 |
| **Total Workflows** | 11 (8 main + 3 sub) |
| **Tests Passed** | **7 / 8** |
| **Tests Failed** | 0 |
| **Tests Blocked** | 1 (webhook registration bug) |
| **Bugs Found** | 2 |
| **Bugs Fixed** | 1 |
| **Bugs Open** | 1 |

---

## Test Environment

- **CRM**: `https://thayduydaotaolaixe.com` (Next.js + PostgreSQL)
- **N8N**: `https://n8n.thayduydaotaolaixe.com` (Docker, v2.8.3)
- **Server**: Ubuntu, `76.13.190.139`
- **Test Data**: Branch `TEST`, 5 users, 45 leads, 171 events, 5 students, 5 receipts, 7 KPI targets, 5 outbound messages

---

## Test Results

### ✅ D0: Smoke Test (`simulate-n8n.sh`)

| Endpoint | Result |
|----------|--------|
| `auth/login` | ✅ PASS (HTTP 200, token OK) |
| `cron/daily` | ✅ PASS (HTTP 200) |
| `worker/outbound` | ✅ PASS (HTTP 200) |
| `ops/pulse` | ✅ PASS (HTTP 200) |
| `marketing/report` | ✅ PASS (HTTP 200) |
| `leads/stale` | ✅ PASS (HTTP 200) |
| `public/lead` | ✅ PASS (HTTP 200) |

**Result: 7/7 PASS** | correlationId: `7eaf64d8-ca69-42b3-9448-40c3a9f980fe`

---

### ✅ D1: 01 Daily Cron Master

- **Trigger**: `POST /api/cron/daily` (`force=true`)
- **Result**: 3 notifications created, 3 outbound queued
- **Details**:
  - 3 HIGH priority notifications for students with remaining tuition (Test Lead 37, 38, 39)
  - Templates: `remind_remaining`, `remind_paid50`
  - Each notification auto-queued into OutboundMessage
- **CorrelationId**: `e2e-1771476784-w01`

---

### ⚠️ D2: 02 Facebook Lead Capture

- **Trigger**: `POST /webhook/facebook-lead` (n8n webhook)
- **Result**: **BLOCKED** — webhook returns HTTP 404
- **Root Cause**: n8n v2.8.3 webhook registration bug (see BUG #1 below)
- **Workaround**: The CRM endpoint `/api/public/lead` works correctly (tested in D8)
- **W02 workflow logic**: Webhook → Extract FB leadgen_id → Graph API → Transform → Create Lead → Auto-Assign

> [!WARNING]
> W02 needs Facebook Graph API token (`FB_PAGE_TOKEN` env var) to function in production. Currently not set.

---

### ✅ D3: 03 Marketing Ads Sync

- **Trigger**: `POST /api/marketing/report`
- **Result**: MarketingReport row created
- **Evidence**:
  ```json
  {"ok":true,"item":{"id":"cmlszk1em000s01qotnl6hox3","dateKey":"2026-02-19","source":"meta_ads_test","spendVnd":500000,"messages":25,"cplVnd":20000}}
  ```
- **CorrelationId**: `e2e-1771476813-w03`

> [!NOTE]
> API field is `date` not `dateKey`. The workflow JSON sends `date` correctly.

---

### ✅ D4: 04 AI KPI Coach

- **Trigger**: Manual execution via n8n editor
- **Result**: All 9 nodes executed successfully
- **Node Flow**: `TRG_Schedule` → `AUTH_GetToken` → `HTTP_GetKPI` + `HTTP_GetStale` → `MAP_MergeData` → `MAP_BuildPrompt` → `HTTP_AI` (OpenAI GPT) → `MAP_ParseSuggestions` (3 items) → `HTTP_SaveSuggestion` (3 saved)
- **Evidence**: 5 AI Suggestions in DB (3 from this test + 2 prior)
- **Fix Applied**: `N8N_BLOCK_ENV_ACCESS_IN_NODE=false` + `N8N_RUNNERS_TASK_ENV_ALLOW_LIST` (see BUG #2 FIX)

---

### ✅ D5: 05 Outbound Message Worker

- **Trigger**: `POST /api/worker/outbound` (`dryRun=false`)
- **Result**: 8 messages processed (all FAILED — expected, no real Zalo/SMS sender)
- **Evidence**:
  ```json
  {"ok":true,"processed":8,"sent":0,"failed":8,"skipped":0,"rateLimited":0}
  ```
- **CorrelationId**: `e2e-1771476784-w05`

> [!NOTE]
> All messages FAILED because there's no production Zalo/SMS gateway configured. This is expected behavior — the worker correctly processes and attempts delivery.

---

### ✅ D6: 06 Ops Pulse Report

- **Trigger**: `POST /api/ops/pulse`
- **Result**: OpsPulse computed and stored
- **Evidence**:
  ```json
  {"ok":true,"id":"cmlsziviz000e01qorn676znl","status":"OK","computedJson":{"role":"PAGE","metrics":{"messagesToday":25,"dataToday":8},"targets":{"dataRatePctTarget":20},"gaps":{"dataRatePct":0},"suggestions":["Tỷ lệ ra Data trong ngày đang đạt mục tiêu."]}}
  ```
- **CorrelationId**: `e2e-1771476784-w06`

---

### ✅ D7: 07 Stale Lead Alert & Auto-Assign

- **Trigger**: `GET /api/leads/stale`
- **Result**: 8 stale leads detected correctly
- **Evidence**:
  ```
  HAS_PHONE | HIGH   | 5d | Test Lead 11-14 (4 leads)
  APPOINTED | MEDIUM | 3d | Test Lead 21-24 (4 leads)
  ```
- **CorrelationId**: `e2e-1771476844-w07`

---

### ✅ D8: 08 Landing CRM Zalo Notify

- **Trigger**: `POST /api/public/lead` (direct CRM API — webhook variant blocked by BUG #1)
- **Result**: Lead created in DB, status=HAS_PHONE, auto-assigned to default branch
- **Evidence** (DB):
  ```
  id: cmlszk1kr000t01qobnt6q0kd | fullName: Test Landing Lead N8N | phone: 0989999901 | source: landing | status: HAS_PHONE
  ```
- **CorrelationId**: `e2e-1771476813-w08`

---

## DB Evidence Summary

| Entity | Count | Source |
|--------|-------|--------|
| Test Leads | 45 | Seeded |
| Lead Events | 171 | Seeded |
| Stale Leads | 8 | Seeded (verified by D7) |
| Landing Leads | 1 | Created by D8 |
| Students | 5 | Seeded |
| Receipts | 5 | Seeded |
| AI Suggestions | 5 | Created by D4 |
| MarketingReport | 1 | Created by D3 |
| OpsPulse | 2 | Created by D6 |
| Outbound Failed | 8 | Processed by D5 |

---

## Bugs Found

### BUG #1: Webhook Registration Failure (n8n v2.8.3) — OPEN

**Severity**: HIGH  
**Status**: OPEN (n8n platform issue)

**Description**: Production webhook URLs (`/webhook/facebook-lead`, `/webhook/landing-lead`) return HTTP 404 despite workflows being active. The `webhook_entity` table in n8n's PostgreSQL has entries, but n8n's in-memory webhook router doesn't register them.

**Investigation**:
- `webhook_entity` table shows paths: `d4VbLHU3Li2ORnD7/trg_webhook/facebook-lead`
- `pathLength` was NULL → set to 1 → still 404
- Full container restart (docker compose down/up) → still 404
- Deactivate/reactivate via REST API → still 404
- Deactivate/reactivate via UI → still 404
- n8n logs show "Activated workflow" but webhook is "not registered"

**Root Cause**: Likely related to n8n v2.x "Published Workflow" feature. The `workflow_published_version` table is empty. n8n v2.x may require a formal "Publish" action (not just activation) for production webhooks.

**Workaround**: 
1. D2: Use CRM's `/api/public/lead` endpoint directly (same result)
2. D8: Use CRM's `/api/public/lead` endpoint directly (tested and working)
3. Both W02 and W08 can operate via CRM API polling instead of webhooks

**Recommendation**: 
- Upgrade to latest n8n or check n8n community forum for webhook registration fix
- Consider using n8n's "Publish" button in the UI to formally publish webhook workflows
- Alternative: switch W02/W08 from Webhook trigger to Schedule trigger (poll CRM periodically)

---

### BUG #2: `$env` Access Denied in Task Runner — FIXED ✅

**Severity**: HIGH  
**Status**: FIXED

**Description**: W04 AI KPI Coach failed at `AUTH_GetToken` node with "access to env vars denied". The sub-workflow S1 uses `$env.CRM_BASE_URL`, `$env.CRM_EMAIL`, `$env.CRM_PASSWORD` which were blocked by n8n v2.x task runner isolation.

**Fix Applied**:
Added to `docker-compose.yml` → `n8n` service → `environment`:
```yaml
N8N_BLOCK_ENV_ACCESS_IN_NODE: "false"
N8N_RUNNERS_TASK_ENV_ALLOW_LIST: "CRM_BASE_URL,CRM_EMAIL,CRM_PASSWORD,OPENAI_API_KEY,CRON_SECRET,WORKER_SECRET,OPS_SECRET,MARKETING_SECRET,FB_PAGE_TOKEN"
N8N_COMMUNITY_INCLUDE_CREDENTIALS_ON_EXEC: "true"
```

---

## Improvements & Recommendations

### Critical
1. **Fix webhook registration** — either publish workflows formally or migrate W02/W08 to use CRM API polling
2. **Set `FB_PAGE_TOKEN`** env var for Facebook Graph API (W02 needs this for production)
3. **Configure Zalo/SMS gateway** for outbound messages (W05)

### Important
4. **Add `webhookId`** to webhook nodes — explicit IDs prevent path collisions
5. **Pin n8n version** in docker-compose (`n8nio/n8n:2.8.3` instead of `latest`)
6. **Add health check** endpoint for n8n in Nginx (`/healthz`)
7. **Set up Telegram bot** for S2 Alert Admin (currently no notification channel configured)

### Nice to Have
8. **Add retry logic** to HTTP nodes (currently `timeout: 15000` but no retry)
9. **Add dead-letter queue** for outbound messages that fail > 3 times
10. **Dashboard widget** in CRM showing n8n workflow execution status
11. **Monitoring**: set up Prometheus/Grafana for n8n execution metrics
12. **Backup**: automate n8n PostgreSQL daily backup (`pg_dump`)

---

## Files Modified

| File | Change |
|------|--------|
| `/opt/n8n/.env` | Added `OPENAI_API_KEY`, `N8N_BLOCK_ENV_ACCESS_IN_NODE=false`, `N8N_RUNNERS_TASK_ENV_ALLOW_LIST`, stability settings |
| `/opt/n8n/docker-compose.yml` | Added `N8N_BLOCK_ENV_ACCESS_IN_NODE`, `N8N_RUNNERS_TASK_ENV_ALLOW_LIST`, `N8N_COMMUNITY_INCLUDE_CREDENTIALS_ON_EXEC` to environment block |

---

*Report generated: 2026-02-19T12:30 ICT*
