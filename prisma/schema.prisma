generator client {
  provider = "prisma-client-js"
}
datasource db {
  provider = "postgresql"
}


enum Role {
  admin
  manager
  telesales
  direct_page
  viewer
}

enum LeadStatus {
  NEW
  HAS_PHONE
  APPOINTED
  ARRIVED
  SIGNED
  STUDYING
  EXAMED
  RESULT
  LOST
}

enum LeadEventType {
  NEW
  HAS_PHONE
  APPOINTED
  ARRIVED
  SIGNED
  STUDYING
  EXAMED
  RESULT
  LOST
  CALLED
  OWNER_CHANGED
  ASSIGNED_OWNER
  OTHER
}

enum CallOutcome {
  no_answer
  interested
  not_interested
  wrong_number
  call_back
}

enum AppointmentOutcome {
  confirmed
  rescheduled
  cancelled
  no_show
}

enum ArrivalOutcome {
  arrived_ok
  arrived_waiting
  arrived_refused
}

enum ExamResult {
  pass
  fail
}

enum StudyStatus {
  studying
  paused
  done
}

enum ReceiptMethod {
  cash
  bank_transfer
  card
  other
}

enum MessageDirection {
  inbound
  outbound
}

enum ScheduleType {
  study
  exam
  reminder
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
}

enum StudentContentCategory {
  HUONG_DAN
  MEO_HOC
  HO_SO
  THI
}

enum AutomationStatus {
  sent
  failed
  skipped
}

enum NotificationScope {
  FINANCE
  FOLLOWUP
  SCHEDULE
  SYSTEM
}

enum NotificationStatus {
  NEW
  DOING
  DONE
  SKIPPED
}

enum NotificationPriority {
  HIGH
  MEDIUM
  LOW
}

enum OutboundChannel {
  ZALO
  FB
  SMS
  CALL_NOTE
}

enum OutboundStatus {
  QUEUED
  SENT
  FAILED
  SKIPPED
}

enum OutboundPriority {
  HIGH
  MEDIUM
  LOW
}

enum OpsPulseRole {
  PAGE
  TELESALES
}

enum EmployeeKpiRole {
  PAGE
  TELESALES
}

enum HrAttendanceStatus {
  PRESENT
  HALF
  OFF
  LEAVE_PAID
  LEAVE_UNPAID
  LATE
  ABSENT
}

enum HrAttendanceSource {
  MANUAL
  IMPORT
  DEVICE
}

enum CommissionSourceType {
  RECEIPT
  LEAD
  STUDENT
  MANUAL_ADJUST
  PAID50
}

enum PayrollStatus {
  DRAFT
  FINAL
  PAID
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  role      Role     @default(viewer)
  isActive  Boolean  @default(true)
  branchId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branch    Branch?   @relation(fields: [branchId], references: [id], onDelete: SetNull)
  leads     Lead[]    @relation("OwnerLeads")
  receipts  Receipt[] @relation("ReceiptCreatedBy")
  events    LeadEvent[] @relation("EventCreatedBy")
  notifications Notification[] @relation("OwnerNotifications")
  attendanceSessions AttendanceSession[] @relation("AttendanceSessionCreatedBy")
  attendanceRecords AttendanceRecord[] @relation("AttendanceRecordUpdatedBy")
  attendanceAudits AttendanceAudit[] @relation("AttendanceAuditActor")
  salaryProfiles SalaryProfile[]
  attendances Attendance[]
  commissionLedgers CommissionLedger[]
  payrollItems PayrollItem[]
  generatedPayrollRuns PayrollRun[] @relation("PayrollGeneratedBy")
  opsPulses OpsPulse[]
  employeeKpiSettings EmployeeKpiSetting[]

  @@index([branchId])
}

model Lead {
  id          String     @id @default(cuid())
  fullName    String?
  phone       String?    @unique
  province    String?
  licenseType String?
  source      String?
  channel     String?
  status      LeadStatus @default(NEW)

  ownerId     String?
  owner       User?      @relation("OwnerLeads", fields: [ownerId], references: [id])

  callOutcome    CallOutcome?
  apptOutcome    AppointmentOutcome?
  arrivalOutcome ArrivalOutcome?

  note         String?
  tags         String[]   @default([])
  lastContactAt DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  messages      LeadMessage[]
  outboundMessages OutboundMessage[]
  events        LeadEvent[]
  student       Student?
  automationLogs AutomationLog[]
  notifications Notification[]

  @@index([ownerId, createdAt])
}

model LeadMessage {
  id        String           @id @default(cuid())
  leadId    String
  channel   String
  direction MessageDirection
  content   String
  externalMessageId String?
  createdAt DateTime         @default(now())

  lead      Lead             @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId, createdAt])
}

model LeadEvent {
  id        String   @id @default(cuid())
  leadId    String
  type      LeadEventType
  payload   Json?
  createdAt DateTime @default(now())

  createdById String?
  createdBy   User?  @relation("EventCreatedBy", fields: [createdById], references: [id])

  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId, createdAt])
  @@index([type, createdAt])
}

model TuitionPlan {
  id          String   @id @default(cuid())
  province    String
  licenseType String
  tuition     Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  students    Student[]

  @@unique([province, licenseType])
  @@index([province, licenseType])
}

model Course {
  id          String   @id @default(cuid())
  code        String   @unique
  province    String?
  licenseType String?
  startDate   DateTime?
  examDate    DateTime?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  students    Student[]
  scheduleItems CourseScheduleItem[]
  notifications Notification[]
}

model CourseScheduleItem {
  id        String       @id @default(cuid())
  courseId  String
  type      ScheduleType
  title     String
  startAt   DateTime
  endAt     DateTime?
  rule      Json?
  isActive  Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  course    Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  attendanceSession AttendanceSession?
  attendanceRecords AttendanceRecord[]
  attendanceAudits AttendanceAudit[]

  @@index([courseId, startAt])
}

model Student {
  id              String       @id @default(cuid())
  leadId          String       @unique
  courseId        String?

  tuitionPlanId   String?
  tuitionPlan     TuitionPlan? @relation(fields: [tuitionPlanId], references: [id])

  tuitionSnapshot Int?
  signedAt        DateTime?
  arrivedAt       DateTime?

  studyStatus     StudyStatus  @default(studying)
  examDate        DateTime?
  examStatus      String?
  examResult      ExamResult?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  lead            Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  course          Course?      @relation(fields: [courseId], references: [id])

  receipts        Receipt[]
  commissionLedgers CommissionLedger[]
  outboundMessages OutboundMessage[]
  automationLogs  AutomationLog[]
  notifications   Notification[]
  attendanceRecords AttendanceRecord[]
  account       StudentAccount?

  @@index([courseId])
}

model StudentAccount {
  id           String   @id @default(cuid())
  phone        String   @unique
  passwordHash String
  studentId    String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  student      Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model StudentContent {
  id          String                 @id @default(cuid())
  category    StudentContentCategory
  title       String
  body        String
  isPublished Boolean                @default(false)
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt

  @@index([category, isPublished, createdAt])
}

model AttendanceSession {
  id            String   @id @default(cuid())
  scheduleItemId String  @unique
  note          String?
  createdById   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  scheduleItem  CourseScheduleItem @relation(fields: [scheduleItemId], references: [id], onDelete: Cascade)
  createdBy     User?   @relation("AttendanceSessionCreatedBy", fields: [createdById], references: [id])
  records       AttendanceRecord[]
}

model AttendanceRecord {
  id            String           @id @default(cuid())
  sessionId     String
  scheduleItemId String
  studentId     String
  status        AttendanceStatus
  note          String?
  updatedById   String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  session       AttendanceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  scheduleItem  CourseScheduleItem @relation(fields: [scheduleItemId], references: [id], onDelete: Cascade)
  student       Student            @relation(fields: [studentId], references: [id], onDelete: Cascade)
  updatedBy     User?              @relation("AttendanceRecordUpdatedBy", fields: [updatedById], references: [id])

  @@unique([studentId, scheduleItemId])
  @@index([scheduleItemId, createdAt])
}

model AttendanceAudit {
  id            String   @id @default(cuid())
  scheduleItemId String
  actorId       String?
  action        String
  diff          Json?
  createdAt     DateTime @default(now())

  scheduleItem  CourseScheduleItem @relation(fields: [scheduleItemId], references: [id], onDelete: Cascade)
  actor         User?   @relation("AttendanceAuditActor", fields: [actorId], references: [id])

  @@index([scheduleItemId, createdAt])
}

model Receipt {
  id          String        @id @default(cuid())
  studentId   String
  amount      Int
  method      ReceiptMethod @default(cash)
  note        String?
  receivedAt  DateTime      @default(now())
  createdAt   DateTime      @default(now())

  createdById String?
  createdBy   User?         @relation("ReceiptCreatedBy", fields: [createdById], references: [id])

  student     Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId, receivedAt])
}

model AutomationLog {
  id          String           @id @default(cuid())
  leadId      String?
  studentId   String?
  channel     String
  templateKey String?
  milestone   String?
  status      AutomationStatus @default(sent)
  sentAt      DateTime         @default(now())
  payload     Json?

  lead        Lead?            @relation(fields: [leadId], references: [id], onDelete: Cascade)
  student     Student?         @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([leadId, sentAt])
  @@index([studentId, sentAt])
}

model Notification {
  id        String               @id @default(cuid())
  scope     NotificationScope
  status    NotificationStatus   @default(NEW)
  priority  NotificationPriority @default(MEDIUM)
  title     String
  message   String
  payload   Json?
  leadId    String?
  studentId String?
  courseId  String?
  ownerId   String?
  dueAt     DateTime?
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  lead      Lead?                @relation(fields: [leadId], references: [id], onDelete: Cascade)
  student   Student?             @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course    Course?              @relation(fields: [courseId], references: [id], onDelete: SetNull)
  owner     User?                @relation("OwnerNotifications", fields: [ownerId], references: [id], onDelete: SetNull)
  outboundMessages OutboundMessage[]

  @@index([scope, status, dueAt])
  @@index([ownerId, createdAt])
  @@index([studentId, scope, status])
}

model NotificationRule {
  id        String            @id @default(cuid())
  scope     NotificationScope
  name      String            @unique
  isActive  Boolean           @default(true)
  config    Json
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
}

model MessageTemplate {
  id        String          @id @default(cuid())
  key       String          @unique
  title     String
  channel   OutboundChannel
  body      String
  isActive  Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
}

model OutboundMessage {
  id             String          @id @default(cuid())
  channel        OutboundChannel
  to             String?
  templateKey    String
  renderedText   String
  status         OutboundStatus  @default(QUEUED)
  priority       OutboundPriority @default(MEDIUM)
  error          String?
  leadId         String?
  studentId      String?
  notificationId String?
  retryCount     Int             @default(0)
  nextAttemptAt  DateTime?
  providerMessageId String?
  leaseId        String?
  leaseExpiresAt DateTime?
  dispatchedAt   DateTime?
  createdAt      DateTime        @default(now())
  sentAt         DateTime?

  lead           Lead?           @relation(fields: [leadId], references: [id], onDelete: Cascade)
  student        Student?        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  notification   Notification?   @relation(fields: [notificationId], references: [id], onDelete: SetNull)

  @@index([status, nextAttemptAt])
  @@index([leaseExpiresAt])
  @@index([studentId, createdAt])
  @@index([leadId, createdAt])
}

model Branch {
  id        String   @id @default(cuid())
  name      String
  code      String?  @unique
  isActive  Boolean  @default(true)
  commissionPerPaid50 Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  salaryProfiles SalaryProfile[]
  attendances Attendance[]
  commissionLedgers CommissionLedger[]
  payrollRuns PayrollRun[]
  marketingReports MarketingReport[]
  opsPulses OpsPulse[]
}

model CommissionScheme {
  id        String   @id @default(cuid())
  name      String
  role      String?
  rulesJson Json
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  salaryProfiles SalaryProfile[]
}

model SalaryProfile {
  id                 String   @id @default(cuid())
  userId             String
  branchId           String
  roleTitle          String
  baseSalaryVnd      Int
  allowanceVnd       Int      @default(0)
  standardDays       Int
  commissionSchemeId String?
  effectiveFrom      DateTime
  effectiveTo        DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch             Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  commissionScheme   CommissionScheme? @relation(fields: [commissionSchemeId], references: [id], onDelete: SetNull)

  @@index([userId, effectiveFrom])
  @@index([branchId, effectiveFrom])
}

model Attendance {
  id          String           @id @default(cuid())
  userId      String
  branchId    String
  date        DateTime
  status      HrAttendanceStatus
  minutesLate Int?
  note        String?
  source      HrAttendanceSource @default(MANUAL)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch      Branch           @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([branchId, date])
}

model CommissionLedger {
  id            String               @id @default(cuid())
  userId        String
  branchId      String
  periodMonth   String
  sourceType    CommissionSourceType
  sourceId      String?
  studentId     String?
  amountBaseVnd Int
  commissionVnd Int
  note          String?
  metaJson      Json?
  createdAt     DateTime             @default(now())

  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch        Branch               @relation(fields: [branchId], references: [id], onDelete: Cascade)
  student       Student?             @relation(fields: [studentId], references: [id], onDelete: SetNull)

  @@index([periodMonth, userId])
  @@index([branchId, periodMonth])
  @@unique([sourceType, studentId])
}

model PayrollRun {
  id            String        @id @default(cuid())
  month         String
  branchId      String
  status        PayrollStatus @default(DRAFT)
  generatedAt   DateTime?
  generatedById String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  branch        Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  generatedBy   User?         @relation("PayrollGeneratedBy", fields: [generatedById], references: [id], onDelete: SetNull)
  items         PayrollItem[]

  @@unique([month, branchId])
}

model PayrollItem {
  id              String   @id @default(cuid())
  payrollRunId    String
  userId          String
  baseSalaryVnd   Int
  allowanceVnd    Int
  daysWorked      Float
  standardDays    Int
  baseProratedVnd Int
  commissionVnd   Int
  penaltyVnd      Int
  bonusVnd        Int
  totalVnd        Int
  breakdownJson   Json
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  payrollRun      PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([payrollRunId, userId])
}

model MarketingReport {
  id        String   @id @default(cuid())
  date      DateTime
  dateKey   String
  branchId  String?
  source    String
  spendVnd  Int
  messages  Int
  cplVnd    Int
  metaJson  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branch    Branch?  @relation(fields: [branchId], references: [id], onDelete: SetNull)

  @@unique([dateKey, branchId, source])
  @@index([dateKey])
  @@index([branchId, dateKey])
}

model OpsPulse {
  id            String       @id @default(cuid())
  createdAt     DateTime     @default(now())
  role          OpsPulseRole
  ownerId       String?
  ownerScopeKey String       @default("")
  branchId      String?
  branchScopeKey String      @default("")
  dateKey       String
  windowMinutes Int          @default(10)
  bucketStart   DateTime
  payloadJson   Json
  computedJson  Json

  owner         User?        @relation(fields: [ownerId], references: [id], onDelete: SetNull)
  branch        Branch?      @relation(fields: [branchId], references: [id], onDelete: SetNull)

  @@index([role, dateKey, createdAt])
  @@index([ownerId, createdAt])
  @@unique([role, dateKey, windowMinutes, bucketStart, ownerScopeKey, branchScopeKey])
}

model EmployeeKpiSetting {
  id            String          @id @default(cuid())
  userId        String
  role          EmployeeKpiRole
  effectiveFrom DateTime
  effectiveTo   DateTime?
  targetsJson   Json
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, role, effectiveFrom])
  @@index([role, isActive])
}
