generator client {
  provider = "prisma-client-js"
}
datasource db {
  provider = "postgresql"
}


enum Role {
  admin
  manager
  telesales
  direct_page
  viewer
}

enum LeadStatus {
  NEW
  HAS_PHONE
  APPOINTED
  ARRIVED
  SIGNED
  STUDYING
  EXAMED
  RESULT
  LOST
}

enum CallOutcome {
  no_answer
  interested
  not_interested
  wrong_number
  call_back
}

enum AppointmentOutcome {
  confirmed
  rescheduled
  cancelled
  no_show
}

enum ArrivalOutcome {
  arrived_ok
  arrived_waiting
  arrived_refused
}

enum ExamResult {
  pass
  fail
}

enum StudyStatus {
  studying
  paused
  done
}

enum ReceiptMethod {
  cash
  bank_transfer
  card
  other
}

enum MessageDirection {
  inbound
  outbound
}

enum ScheduleType {
  study
  exam
  reminder
}

enum AutomationStatus {
  sent
  failed
  skipped
}

enum NotificationScope {
  FINANCE
  FOLLOWUP
  SCHEDULE
  SYSTEM
}

enum NotificationStatus {
  NEW
  DOING
  DONE
  SKIPPED
}

enum NotificationPriority {
  HIGH
  MEDIUM
  LOW
}

enum OutboundChannel {
  ZALO
  FB
  SMS
  CALL_NOTE
}

enum OutboundStatus {
  QUEUED
  SENT
  FAILED
  SKIPPED
}

enum OutboundPriority {
  HIGH
  MEDIUM
  LOW
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  role      Role     @default(viewer)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leads     Lead[]    @relation("OwnerLeads")
  receipts  Receipt[] @relation("ReceiptCreatedBy")
  events    LeadEvent[] @relation("EventCreatedBy")
  notifications Notification[] @relation("OwnerNotifications")
}

model Lead {
  id          String     @id @default(cuid())
  fullName    String?
  phone       String?    @unique
  province    String?
  licenseType String?
  source      String?
  channel     String?
  status      LeadStatus @default(NEW)

  ownerId     String?
  owner       User?      @relation("OwnerLeads", fields: [ownerId], references: [id])

  callOutcome    CallOutcome?
  apptOutcome    AppointmentOutcome?
  arrivalOutcome ArrivalOutcome?

  note         String?
  tags         String[]   @default([])
  lastContactAt DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  messages      LeadMessage[]
  outboundMessages OutboundMessage[]
  events        LeadEvent[]
  student       Student?
  automationLogs AutomationLog[]
  notifications Notification[]

  @@index([ownerId, createdAt])
}

model LeadMessage {
  id        String           @id @default(cuid())
  leadId    String
  channel   String
  direction MessageDirection
  content   String
  externalMessageId String?
  createdAt DateTime         @default(now())

  lead      Lead             @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId, createdAt])
}

model LeadEvent {
  id        String   @id @default(cuid())
  leadId    String
  type      String
  payload   Json?
  createdAt DateTime @default(now())

  createdById String?
  createdBy   User?  @relation("EventCreatedBy", fields: [createdById], references: [id])

  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId, createdAt])
  @@index([type, createdAt])
}

model TuitionPlan {
  id          String   @id @default(cuid())
  province    String
  licenseType String
  tuition     Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  students    Student[]

  @@unique([province, licenseType])
  @@index([province, licenseType])
}

model Course {
  id          String   @id @default(cuid())
  code        String   @unique
  province    String?
  licenseType String?
  startDate   DateTime?
  examDate    DateTime?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  students    Student[]
  scheduleItems CourseScheduleItem[]
  notifications Notification[]
}

model CourseScheduleItem {
  id        String       @id @default(cuid())
  courseId  String
  type      ScheduleType
  title     String
  startAt   DateTime
  endAt     DateTime?
  rule      Json?
  isActive  Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  course    Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId, startAt])
}

model Student {
  id              String       @id @default(cuid())
  leadId          String       @unique
  courseId        String?

  tuitionPlanId   String?
  tuitionPlan     TuitionPlan? @relation(fields: [tuitionPlanId], references: [id])

  tuitionSnapshot Int?
  signedAt        DateTime?
  arrivedAt       DateTime?

  studyStatus     StudyStatus  @default(studying)
  examDate        DateTime?
  examStatus      String?
  examResult      ExamResult?

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  lead            Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  course          Course?      @relation(fields: [courseId], references: [id])

  receipts        Receipt[]
  outboundMessages OutboundMessage[]
  automationLogs  AutomationLog[]
  notifications   Notification[]

  @@index([courseId])
}

model Receipt {
  id          String        @id @default(cuid())
  studentId   String
  amount      Int
  method      ReceiptMethod @default(cash)
  note        String?
  receivedAt  DateTime      @default(now())
  createdAt   DateTime      @default(now())

  createdById String?
  createdBy   User?         @relation("ReceiptCreatedBy", fields: [createdById], references: [id])

  student     Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId, receivedAt])
}

model AutomationLog {
  id          String           @id @default(cuid())
  leadId      String?
  studentId   String?
  channel     String
  templateKey String?
  milestone   String?
  status      AutomationStatus @default(sent)
  sentAt      DateTime         @default(now())
  payload     Json?

  lead        Lead?            @relation(fields: [leadId], references: [id], onDelete: Cascade)
  student     Student?         @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([leadId, sentAt])
  @@index([studentId, sentAt])
}

model Notification {
  id        String               @id @default(cuid())
  scope     NotificationScope
  status    NotificationStatus   @default(NEW)
  priority  NotificationPriority @default(MEDIUM)
  title     String
  message   String
  payload   Json?
  leadId    String?
  studentId String?
  courseId  String?
  ownerId   String?
  dueAt     DateTime?
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  lead      Lead?                @relation(fields: [leadId], references: [id], onDelete: Cascade)
  student   Student?             @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course    Course?              @relation(fields: [courseId], references: [id], onDelete: SetNull)
  owner     User?                @relation("OwnerNotifications", fields: [ownerId], references: [id], onDelete: SetNull)
  outboundMessages OutboundMessage[]

  @@index([scope, status, dueAt])
  @@index([ownerId, createdAt])
  @@index([studentId, scope, status])
}

model NotificationRule {
  id        String            @id @default(cuid())
  scope     NotificationScope
  name      String            @unique
  isActive  Boolean           @default(true)
  config    Json
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
}

model MessageTemplate {
  id        String          @id @default(cuid())
  key       String          @unique
  title     String
  channel   OutboundChannel
  body      String
  isActive  Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
}

model OutboundMessage {
  id             String          @id @default(cuid())
  channel        OutboundChannel
  to             String?
  templateKey    String
  renderedText   String
  status         OutboundStatus  @default(QUEUED)
  priority       OutboundPriority @default(MEDIUM)
  error          String?
  leadId         String?
  studentId      String?
  notificationId String?
  retryCount     Int             @default(0)
  nextAttemptAt  DateTime?
  providerMessageId String?
  leaseId        String?
  leaseExpiresAt DateTime?
  dispatchedAt   DateTime?
  createdAt      DateTime        @default(now())
  sentAt         DateTime?

  lead           Lead?           @relation(fields: [leadId], references: [id], onDelete: Cascade)
  student        Student?        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  notification   Notification?   @relation(fields: [notificationId], references: [id], onDelete: SetNull)

  @@index([status, nextAttemptAt])
  @@index([leaseExpiresAt])
  @@index([studentId, createdAt])
  @@index([leadId, createdAt])
}
